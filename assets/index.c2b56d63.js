import{r as S,a as C,w as y,o as B,b as m,c as v,d as k,e as b,f as J,n as Y,u as _,g as W,F as N,h as V,i as K,j as z,k as w,l as U,t as j,m as X,v as tt,E as et,p as ot,q as $,s as nt}from"./vendor.408fdf1c.js";const at=function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))n(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function t(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerpolicy&&(s.referrerPolicy=a.referrerpolicy),a.crossorigin==="use-credentials"?s.credentials="include":a.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(a){if(a.ep)return;a.ep=!0;const s=t(a);fetch(a.href,s)}};at();const it="639275188584-8dtf7kiol8rtpotanc9pr14vpq9c34lr.apps.googleusercontent.com",st=281622784083772,A="https://ptx.transportdata.tw/MOTC/v2/Rail/Metro",T="TRTC";function lt(e){let[o,t]=e;return[t,o]}function H(e,o){let t=e+"?$filter=";return Object.keys(o).forEach((n,a)=>{t+=a===0?`${n} eq ${Z(o[n])}`:` and ${n} eq ${Z(o[n])}`}),t}function Z(e){return typeof e=="string"?`'${e}'`:e}function rt(e){var o=e.split(".")[1],t=o.replace(/-/g,"+").replace(/_/g,"/"),n=decodeURIComponent(atob(t).split("").map(function(a){return"%"+("00"+a.charCodeAt(0).toString(16)).slice(-2)}).join(""));return JSON.parse(n)}async function ct({}){let e=`${A}/Line/${T}`,o=await P({url:e});return o||null}async function ut(){let e=`${A}/Shape/${T}`,o=await P({url:e});return o||null}async function pt({query:e}){let o=H(`${A}/StationOfRoute/${T}`,e),t=await P({url:o});return t||null}async function dt({query:e}){let o=H(`${A}/StationExit/${T}`,e),t=await P({url:o});return t||null}function P({url:e,method:o="GET"}){return fetch(e,{method:o}).then(async t=>{let n=await t.json();switch(t.status){case 200:return n;case 429:return alert(`${(n==null?void 0:n.message)||""} \u8ACB\u7A0D\u5F8C\u518D\u8A66\u3002`),null;default:return n}}).catch(t=>null)}function ft(e=5e3){try{let o;return navigator.geolocation&&(o=new Promise((t,n)=>navigator.geolocation.getCurrentPosition(t,n,{timeout:e})).then(t=>{var n,a;return[((n=t==null?void 0:t.coords)==null?void 0:n.latitude)||0,((a=t==null?void 0:t.coords)==null?void 0:a.longitude)||0]}).catch(t=>null)),o}catch{}}var q=(e,o)=>{const t=e.__vccOpts||e;for(const[n,a]of o)t[n]=a;return t};const gt={id:"mapid"},_t={props:{avatars:Object,metroData:Object},emits:["updateLocation"],setup(e,{emit:o}){const t=e,n="https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png",a="#aaa";let s={},i={},r={},g=[];const u=S({m:[25.001984,121.5266816]}),d=C(!1),D=C("");y(t.avatars,()=>{let l=Object.values(t.avatars).filter(p=>p).map(p=>`<img src="${p}" style="width: 60px; height: 60px;"/>`).join("");setTimeout(()=>{i.bindTooltip&&i.bindTooltip("Here you are <br/>"+l)},0)}),y(()=>t.metroData.shapeOfList,()=>{l();function l(){window.requestAnimationFrame(()=>d.value?p():l())}function p(){Object.keys(t.metroData.shapeOfList).forEach(c=>{r[c]=L.polyline(t.metroData.shapeOfList[c],{color:a}).addTo(s)})}}),y(()=>t.metroData.selectedLine,()=>{let l=r[t.metroData.selectedLine];if(D.value&&r[D.value].setStyle({color:a}),l){let p=t.metroData.list.find(c=>c.LineID===t.metroData.selectedLine);l.setStyle({color:(p==null?void 0:p.LineColor)||""}),l.bringToFront(),s.fitBounds(l.getBounds())}D.value=t.metroData.selectedLine,I()}),y(()=>t.metroData.exit,()=>{var l,p;I(),g=t.metroData.exit.map(c=>{var O,x;let{ExitPosition:h,ExitName:f,LocationDescription:M}=c,R=((x=(O=f==null?void 0:f.Zh_tw)==null?void 0:O.match(/[\w]+$/g))==null?void 0:x[0])||"\u51FA\u53E3",G=L.divIcon({className:"div-icon",html:`<div>${R}</div>`,iconSize:[20,20]});return L.marker([h.PositionLat,h.PositionLon],{icon:G}).bindTooltip(`${f.Zh_tw} (${f.En})<br/>${M}`).openTooltip().addTo(s)}),((p=(l=t.metroData.exit)==null?void 0:l[0])==null?void 0:p.ExitPosition)&&s.flyTo([t.metroData.exit[0].ExitPosition.PositionLat,t.metroData.exit[0].ExitPosition.PositionLon],18)}),B(async()=>{let l=await ft();l&&(u.m=l),await F()});const F=()=>{s=L.map("mapid",{center:u.m,zoom:15}),s.on("click",l=>{i.setLatLng(l.latlng),o("updateLocation",l.latlng)}),L.tileLayer(n,{maxZoom:20}).addTo(s),i=L.marker(u.m,{draggable:!0,autoPan:!0}).bindTooltip("please login google & facebook first").openTooltip().addTo(s),i.on("moveend",l=>{l.target._latlng&&o("updateLocation",l.target._latlng)}),d.value=!0},I=()=>{g.length&&g.forEach(l=>l.remove()),g=[]};return(l,p)=>(m(),v("div",gt))}};var mt=q(_t,[["__scopeId","data-v-9dd003f6"]]);const Lt={props:{backgroundColor:String,isActive:Boolean},setup(e){const o=e,t=k(()=>({backgroundColor:o.backgroundColor}));return(n,a)=>(m(),v("button",{class:W({isActive:e.isActive})},[b("span",null,[J(n.$slots,"default",{},void 0,!0)]),b("div",{class:"background",style:Y(_(t))},null,4)],2))}};var ht=q(Lt,[["__scopeId","data-v-baa8e354"]]);const vt={class:"flex column",id:"form"},bt={class:"metro flex"},yt={class:"metroLineList flex column"},kt={key:0,class:"metroStationList flex column"},Dt={props:{propData:Object},emits:["chooseOption"],setup(e,{emit:o}){const t=e;C(["1"]);const n=S({lineList:[],stationList:[]}),a=k(()=>{let i=n.lineList.find(r=>r.isActive);return(i==null?void 0:i.bcColor)||""});y(()=>t.propData.list,()=>{n.lineList=t.propData.list.map(i=>({bcColor:i.LineColor,label:`${i.LineName.Zh_tw}(${i.LineID})`,lineId:i.LineID,isActive:!1}))}),y(()=>t.propData.stations,()=>{n.stationList=t.propData.stations.map(i=>({label:`${i.StationName.Zh_tw}(${i.StationID})`,value:i.StationID,isActive:!1}))},{deep:!0});const s=function(i,r,g){g==="line"?n.lineList.forEach((u,d)=>u.isActive=d===r):g==="station"&&n.stationList.forEach((u,d)=>u.isActive=d===r),o("chooseOption",{item:i,type:g})};return(i,r)=>{const g=ht;return m(),v("div",vt,[J(i.$slots,"default",{},void 0,!0),b("div",bt,[b("div",yt,[(m(!0),v(N,null,V(_(n).lineList,(u,d)=>(m(),z(g,{key:d,isActive:u.isActive,backgroundColor:u.bcColor,onClick:D=>s(u,d,"line")},{default:w(()=>[U(j(u.label),1)]),_:2},1032,["isActive","backgroundColor","onClick"]))),128))]),_(n).stationList?(m(),v("div",kt,[(m(!0),v(N,null,V(_(n).stationList,(u,d)=>(m(),z(g,{key:d,isActive:u.isActive,backgroundColor:_(a),onClick:D=>s(u,d,"station")},{default:w(()=>[U(j(u.label),1)]),_:2},1032,["isActive","backgroundColor","onClick"]))),128))])):K("",!0)])])}}};var St=q(Dt,[["__scopeId","data-v-4778d2c4"]]);const $t={id:"facebookLoginButton"},wt=b("div",{class:"fab fa-facebook icon"},null,-1),Ct={props:{isLogin:Boolean},setup(e){const o=e;return(t,n)=>(m(),v("div",$t,[wt,b("span",null,j(o.isLogin?"Facebook \u5E33\u865F\u767B\u51FA":"\u4F7F\u7528 Facebook \u5E33\u865F\u767B\u5165"),1)]))}},It={id:"googleLoginButton"},Ot=b("div",{class:"icon fab fa-google"},null,-1),xt=b("span",null,"Google \u5E33\u865F\u767B\u51FA",-1),Et=[Ot,xt],Bt={props:{isLogin:Boolean},emits:["logout"],setup(e,{emit:o}){const t=e,n=()=>o("logout");return(a,s)=>(m(),v(N,null,[X(b("div",It,null,512),[[tt,!t.isLogin]]),t.isLogin?(m(),v("div",{key:0,id:"googleLogoutButton",onClick:n},Et)):K("",!0)],64))}};function At(e){let o=[],t=new Map;return e.forEach(n=>{n.Stations.forEach(a=>{t.has(a.StationID)||(t.set(a.StationID),o.push(a))})}),o}function Tt(e){let o={};return e.forEach(t=>{let{Geometry:n}=t,a=n.match(/[0-9 \.\,]+[^),(]/g);o[t.LineID]=a.map(s=>s.split(",").map(i=>lt(i.split(" ").map(r=>Number(r)))))}),o}const E={R07:"O06",O05:"G09",G10:"R08",G12:"BL11"};function Pt(e){return(E==null?void 0:E[e])?E[e]:e}function Ft(){const e=S({user:{},isLogin:k(()=>!!e.user.sub)});y(()=>e.isLogin.value,()=>{console.log("google login status change")}),B(()=>{window.onGoogleLibraryLoad=function(){google.accounts.id.initialize({client_id:it,callback:t}),google.accounts.id.renderButton(document.getElementById("googleLoginButton"),{width:"250px"}),google.accounts.id.prompt()}});function o(){e.user.sub&&google.accounts.id.revoke(e.user.sub,n=>{n.successful&&(e.user={},google.accounts.id.disableAutoSelect())})}function t(n){n.credential&&(e.user=rt(n.credential))}return{googleState:e,googleSignout:o}}function Mt(){const e=S({user:{},isLogin:k(()=>!!e.user.id)});y(()=>e.isLogin.value,()=>{console.log("facebook login status change")}),B(()=>{window.onload=function(){FB.init({appId:st,cookie:!0,xfbml:!0,version:"v13.0"}),o()}});function o(){FB.getLoginStatus(function(s){s.status==="connected"?FB.api("/me",{fields:"id,name,email,picture"},function(i){e.user={id:i.id,name:i.name,image:i.picture.data.url,email:(i==null?void 0:i.email)||""}}):e.user={}})}function t(){e.isLogin?a():n()}function n(){FB.login(function(s){o()})}function a(){FB.api("/me/permissions","DELETE",function(s){s.success&&(FB.logout(),e.user={})})}return{facebookState:e,facebookCore:t}}const Rt={class:"wrapper flex"},Gt={class:"flex"},Nt={setup(e){const{googleState:o,googleSignout:t}=Ft(),{facebookState:n,facebookCore:a}=Mt();C(!1);const s=C("1"),i=S({google:k(()=>o.user.picture),facebook:k(()=>n.user.image)}),r=S({list:[],selectedLine:"",shapeOfList:{},shape:[],stationOfList:{},stations:[],exit:[]}),g=S({place:{}}),u=k(()=>o.isLogin),d=k(()=>n.isLogin);B(async()=>{await F(),await I()});const D=async function({item:c,type:h}){var f;switch(h){case"line":((f=r.stationOfList)==null?void 0:f[c.lineId])||await l(c.lineId),r.selectedLine=c.lineId,r.shape=r.shapeOfList[c.lineId],r.stations=r.stationOfList[c.lineId];break;case"station":await p(c.value);break}},F=async function(){let c=await ct({});r.list=c},I=async function(){let c=await ut();r.shapeOfList=Tt(c)},l=async function(c){let f=await pt({query:{LineID:c,Direction:0}});r.stationOfList[c]=At(f)},p=async function(c){let h={StationID:Pt(c)},f=await dt({query:h});r.exit=f||[]};return(c,h)=>{const f=Bt,M=Ct,R=et,G=ot,O=St,x=mt;return m(),v("div",Rt,[$(O,{propData:_(r),onChooseOption:D},{default:w(()=>[$(G,{modelValue:s.value,"onUpdate:modelValue":h[0]||(h[0]=Q=>s.value=Q)},{default:w(()=>[$(R,{title:"\u793E\u7FA4\u5E33\u865F\u767B\u5165",name:"1"},{default:w(()=>[b("div",Gt,[$(f,{isLogin:_(u),onLogout:_(t)},null,8,["isLogin","onLogout"]),$(M,{isLogin:_(d),onClick:_(a)},null,8,["isLogin","onClick"])])]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["propData"]),$(x,{avatars:_(i),placeData:_(g),metroData:_(r)},null,8,["avatars","placeData","metroData"])])}}};nt(Nt).mount("#app");
