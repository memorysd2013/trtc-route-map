import{c as $,o as d,a as g,b as W,t as A,u as m,p as J,d as X,e as b,r as S,f as U,w as I,g as q,n as Y,h as z,F as B,i as j,j as ee,k as G,l as te,m as x,q as ne,s as oe}from"./vendor.94b0a1b1.js";const ie=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function e(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerpolicy&&(a.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?a.credentials="include":i.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(i){if(i.ep)return;i.ep=!0;const a=e(i);fetch(i.href,a)}};ie();const ae="639275188584-8dtf7kiol8rtpotanc9pr14vpq9c34lr.apps.googleusercontent.com",se=281622784083772,E="https://ptx.transportdata.tw/MOTC/v2/Rail/Metro",P="TRTC";let O=null;function re(){O=window.gapi.auth2.getAuthInstance()}async function le(){var t;let n=(t=O.currentUser.get())==null?void 0:t.getBasicProfile();return new Promise(async(e,o)=>{if(n){let i={id:n.getId(),name:n.getName(),image:n.getImageUrl(),email:n.getEmail()};e(i)}else o(null)})}async function ce(){return new Promise(async(n,t)=>{await O.signIn(),n()})}function ue(){return new Promise((n,t)=>{O.disconnect(),O.signOut(),n()})}function de(){return new Promise((n,t)=>{FB.getLoginStatus(function(e){e.status==="connected"?FB.api("/me",{fields:"id,name,email,picture"},function(o){n({id:o.id,name:o.name,image:o.picture.data.url,email:(o==null?void 0:o.email)||""})}):t(null)})})}function pe(){return new Promise((n,t)=>{FB.login(function(e){e.status==="connected"?n():t()})})}function fe(){return new Promise((n,t)=>{FB.api("/me/permissions","DELETE",function(e){FB.logout(),n()})})}setTimeout(()=>{window.gapi.load("auth2",async()=>{await window.gapi.auth2.init({client_id:ae}),re()})},0);window.fbAsyncInit=function(){FB.init({appId:se,cookie:!0,xfbml:!0,version:"v13.0"}),FB.AppEvents.logPageView()};(function(n,t,e){var o,i=n.getElementsByTagName(t)[0];n.getElementById(e)||(o=n.createElement(t),o.id=e,o.src="https://connect.facebook.net/en_US/sdk.js",i.parentNode.insertBefore(o,i))})(document,"script","facebook-jssdk");var w=(n,t)=>{const e=n.__vccOpts||n;for(const[o,i]of t)e[o]=i;return e};const ge=n=>(J("data-v-53e5bf82"),n=n(),X(),n),_e=ge(()=>b("i",{class:"icon"},null,-1)),me={props:{identity:Object,identityKey:String},emits:["clearUser","setUser"],setup(n,{emit:t}){const e=n,o=$(()=>{var a,s;return!!((s=(a=e.identity)==null?void 0:a.user)==null?void 0:s.id)});$(()=>{var a;return((a=e.identity)==null?void 0:a.icon)||""});const i=()=>{o.value?e.identity.logout().then(()=>t("clearUser",e.identityKey)):e.identity.login().then(()=>t("setUser",e.identityKey))};return(a,s)=>(d(),g("button",{onClick:i},[W(A(m(o)?"\u767B\u51FA":"\u767B\u5165"),1),_e]))}};var ye=w(me,[["__scopeId","data-v-53e5bf82"]]);function ve(n){let[t,e]=n;return[e,t]}function V(n,t){let e=n+"?$filter=";return Object.keys(t).forEach((o,i)=>{e+=i===0?`${o} eq ${R(t[o])}`:` and ${o} eq ${R(t[o])}`}),e}function R(n){return typeof n=="string"?`'${n}'`:n}async function he({}){let n=`${E}/Line/${P}`,t=await T({url:n});return t||null}async function Le(){let n=`${E}/Shape/${P}`,t=await T({url:n});return t||null}async function be({query:n}){let t=V(`${E}/StationOfRoute/${P}`,n),e=await T({url:t});return e||null}async function Ie({query:n}){let t=V(`${E}/StationExit/${P}`,n),e=await T({url:t});return e||null}function T({url:n,method:t="GET"}){return fetch(n,{method:t}).then(async e=>{let o=await e.json();switch(e.status){case 200:return o;case 429:return alert(`${(o==null?void 0:o.message)||""} \u8ACB\u7A0D\u5F8C\u518D\u8A66\u3002`),null;default:return o}}).catch(e=>null)}function we(n=5e3){try{let t;return navigator.geolocation&&(t=new Promise((e,o)=>navigator.geolocation.getCurrentPosition(e,o,{timeout:n})).then(e=>{var o,i;return[((o=e==null?void 0:e.coords)==null?void 0:o.latitude)||0,((i=e==null?void 0:e.coords)==null?void 0:i.longitude)||0]}).catch(e=>null)),t}catch{}}const ke={id:"mapid"},De={props:{identities:Object,metroData:Object},emits:["updateLocation"],setup(n,{emit:t}){const e=n,o="https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png",i="#aaa";let a={},s={},f={},c=[];const u=S({m:[25.001984,121.5266816]}),y=U(!1),k=U(""),l=$(()=>Object.keys(e.identities).map(r=>{var p,h;return(h=(p=e.identities[r])==null?void 0:p.user)==null?void 0:h.image}).filter(r=>r));I(e.identities,()=>{let r=l.value.map(p=>`<img src="${p}" class="tl-img">`).join("");setTimeout(()=>{s.bindTooltip&&s.bindTooltip("Here you are <br/>"+r)},0)}),I(()=>e.metroData.shapeOfList,()=>{r();function r(){window.requestAnimationFrame(()=>y.value?p():r())}function p(){Object.keys(e.metroData.shapeOfList).forEach(h=>{f[h]=L.polyline(e.metroData.shapeOfList[h],{color:i}).addTo(a)})}}),I(()=>e.metroData.selectedLine,()=>{let r=f[e.metroData.selectedLine];if(k.value&&f[k.value].setStyle({color:i}),r){let p=e.metroData.list.find(h=>h.LineID===e.metroData.selectedLine);r.setStyle({color:(p==null?void 0:p.LineColor)||""}),r.bringToFront(),a.fitBounds(r.getBounds())}k.value=e.metroData.selectedLine,_()}),I(()=>e.metroData.exit,()=>{var r,p;_(),c=e.metroData.exit.map(h=>{var M,N;let{ExitPosition:F,ExitName:D,LocationDescription:Z}=h,H=((N=(M=D==null?void 0:D.Zh_tw)==null?void 0:M.match(/[\w]+$/g))==null?void 0:N[0])||"\u51FA\u53E3",Q=L.divIcon({className:"div-icon",html:`<div>${H}</div>`,iconSize:[20,20]});return L.marker([F.PositionLat,F.PositionLon],{icon:Q}).bindTooltip(`${D.Zh_tw} (${D.En})<br/>${Z}`).openTooltip().addTo(a)}),((p=(r=e.metroData.exit)==null?void 0:r[0])==null?void 0:p.ExitPosition)&&a.flyTo([e.metroData.exit[0].ExitPosition.PositionLat,e.metroData.exit[0].ExitPosition.PositionLon],18)}),q(async()=>{let r=await we();r&&(u.m=r),await v()});const v=()=>{a=L.map("mapid",{center:u.m,zoom:15}),a.on("click",r=>{s.setLatLng(r.latlng),t("updateLocation",r.latlng)}),L.tileLayer(o,{maxZoom:20}).addTo(a),s=L.marker(u.m,{draggable:!0,autoPan:!0}).bindTooltip("please login google & facebook first").openTooltip().addTo(a),s.on("moveend",r=>{r.target._latlng&&t("updateLocation",r.target._latlng)}),y.value=!0},_=()=>{c.length&&c.forEach(r=>r.remove()),c=[]};return(r,p)=>(d(),g("div",ke))}};var Se=w(De,[["__scopeId","data-v-6ab7ff62"]]);const $e={props:{backgroundColor:String,label:String,isActive:Boolean},setup(n){const t=n,e=$(()=>({backgroundColor:t.backgroundColor}));return(o,i)=>(d(),g("button",{class:z({isActive:n.isActive})},[b("span",null,A(n.label),1),b("div",{class:"background",style:Y(m(e))},null,4)],2))}};var K=w($e,[["__scopeId","data-v-26861206"]]);const Oe={class:"flex",id:"form"},xe={class:"metroLineList flex column"},Ce={key:0,class:"metroStationList flex column"},Ae={props:{propData:Object},emits:["chooseOption"],setup(n,{emit:t}){const e=n,o=S({lineList:[],stationList:[]}),i=$(()=>{let s=o.lineList.find(f=>f.isActive);return(s==null?void 0:s.bcColor)||""});I(()=>e.propData.list,()=>{o.lineList=e.propData.list.map(s=>({bcColor:s.LineColor,label:`${s.LineName.Zh_tw}(${s.LineID})`,lineId:s.LineID,isActive:!1}))}),I(()=>e.propData.stations,()=>{o.stationList=e.propData.stations.map(s=>({label:`${s.StationName.Zh_tw}(${s.StationID})`,value:s.StationID,isActive:!1}))},{deep:!0});const a=function(s,f,c){c==="line"?o.lineList.forEach((u,y)=>u.isActive=y===f):c==="station"&&o.stationList.forEach((u,y)=>u.isActive=y===f),t("chooseOption",{item:s,type:c})};return(s,f)=>(d(),g("div",Oe,[b("div",xe,[(d(!0),g(B,null,j(m(o).lineList,(c,u)=>(d(),G(K,{key:u,label:c.label,isActive:c.isActive,backgroundColor:c.bcColor,onClick:y=>a(c,u,"line")},null,8,["label","isActive","backgroundColor","onClick"]))),128))]),m(o).stationList?(d(),g("div",Ce,[(d(!0),g(B,null,j(m(o).stationList,(c,u)=>(d(),G(K,{key:u,label:c.label,isActive:c.isActive,backgroundColor:m(i),onClick:y=>a(c,u,"station")},null,8,["label","isActive","backgroundColor","onClick"]))),128))])):ee("",!0)]))}};var Be=w(Ae,[["__scopeId","data-v-6d94a5f9"]]);const Ee={key:0},Pe={key:1},Te={props:{identities:Object},setup(n){const t=U(!0);return(e,o)=>(d(),g("div",{class:z(["information flex v-center",[t.value&&"collapse"]])},[b("i",{class:"fas fa-caret-left caret-icon",onClick:o[0]||(o[0]=i=>t.value=!t.value)}),(d(!0),g(B,null,j(n.identities,(i,a)=>{var s;return d(),g("div",{key:a},[((s=i.user)==null?void 0:s.id)?(d(),g("span",Ee,"hi, "+A(i.user.name),1)):(d(),g("span",Pe,"\u8ACB\u767B\u5165\u60A8\u7684 "+A(a)+" \u5E33\u865F",1)),te(e.$slots,"default",{identity:i,identityKey:a},void 0,!0)])}),128))],2))}};var Ue=w(Te,[["__scopeId","data-v-62cc0fd4"]]);function je(n){let t=[],e=new Map;return n.forEach(o=>{o.Stations.forEach(i=>{e.has(i.StationID)||(e.set(i.StationID),t.push(i))})}),t}function Fe(n){let t={};return n.forEach(e=>{let{Geometry:o}=e,i=o.match(/[0-9 \.\,]+[^),(]/g);t[e.LineID]=i.map(a=>a.split(",").map(s=>ve(s.split(" ").map(f=>Number(f)))))}),t}const C={R07:"O06",O05:"G09",G10:"R08",G12:"BL11"};function Me(n){return(C==null?void 0:C[n])?C[n]:n}const Ne={class:"infoWrapper"},Ge={class:"wrapper flex"},Re={setup(n){const t=S({google:{user:null,icon:"fab fa-google",login:ce,logout:ue,getUser:le},facebook:{user:null,icon:"fab fa-facebook-f",login:pe,logout:fe,getUser:de}}),e=S({list:[],selectedLine:"",shapeOfList:{},shape:[],stationOfList:{},stations:[],exit:[]}),o=S({place:{}});q(async()=>{setTimeout(()=>{i("google"),i("facebook")},1500),await c(),await u()});const i=function(l){t[l].getUser().then(v=>t[l].user=v).catch(v=>t[l].user=null)},a=function(l){t[l].user=null},s=async function({item:l,type:v}){var _;if(!t.google.user||!t.facebook.user){alert("\u8ACB\u5148\u767B\u5165 Google \u8207 Facebook \u5E33\u865F");return}switch(v){case"line":((_=e.stationOfList)==null?void 0:_[l.lineId])||await y(l.lineId),e.selectedLine=l.lineId,e.shape=e.shapeOfList[l.lineId],e.stations=e.stationOfList[l.lineId];break;case"station":await k(l.value);break}},f=async function(l){if(!t.google.user||!t.google.user){alert("\u8ACB\u5148\u767B\u5165 Google \u8207 Facebook \u5E33\u865F");return}},c=async function(){let l=await he({});e.list=l},u=async function(){let l=await Le();e.shapeOfList=Fe(l)},y=async function(l){let _=await be({query:{LineID:l,Direction:0}});e.stationOfList[l]=je(_)},k=async function(l){let v={StationID:Me(l)},_=await Ie({query:v});e.exit=_||[]};return(l,v)=>(d(),g(B,null,[b("div",Ne,[x(Ue,{identities:m(t)},{default:ne(_=>[x(ye,{identity:_.identity,identityKey:_.identityKey,onSetUser:i,onClearUser:a},null,8,["identity","identityKey"])]),_:1},8,["identities"])]),b("div",Ge,[x(Be,{propData:m(e),onChooseOption:s},null,8,["propData"]),x(Se,{identities:m(t),placeData:m(o),metroData:m(e),onUpdateLocation:f},null,8,["identities","placeData","metroData"])])],64))}};var Ke=w(Re,[["__scopeId","data-v-4baa3273"]]);oe(Ke).mount("#app");
